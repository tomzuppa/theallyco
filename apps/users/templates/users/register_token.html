{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load form_helpers %}

{% block title %}Register | {{ COMPANY_NAME }}{% endblock %}
{% block body_class %}register-page{% endblock %}

{% block extra_head %}
  <!-- Reference: static/css/users/register.css - Custom registration styles -->
  <link rel="stylesheet" href="{% static 'css/users/register.css' %}">
  <!-- Google reCAPTCHA v2 for bot protection -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}

{% block content %}
<section class="vh-100 d-flex align-items-center justify-content-center">
  <div class="container-fluid h-100">
    <div class="row d-flex align-items-center justify-content-center h-100">

      <!-- LEFT SIDE: Branding Information (Desktop only) -->
      <div class="col-md-6 text-light d-none d-md-block register-info text-center">
        <h1 class="fw-bold">
          <!-- Reference: core/utils.py - get_signup_branding() provides these values -->
          <span class="headline-main">{{ branding.title }}</span><br>
          <span class="headline-sub">{{ branding.subtitle }}</span>
        </h1>
        <p class="text-muted paragraph-color fs-5 mt-4">
          {{ branding.description|linebreaksbr }}
        </p>
      </div>

      <!-- RIGHT SIDE: Registration Form -->
      <div class="col-md-6">
        <div class="card register-card shadow">
          <div class="card-body p-4">
            <!-- Dynamic title based on registration step -->
            <h2 class="text-center mb-4">
              {% if show_token_field %}
                Verify Your Account
              {% else %}
                Create Your Account
              {% endif %}
            </h2>

            <!-- Token status message container for AJAX updates -->
            <div id="token-status-message"></div>

            <!-- Main registration/verification form -->
            <form method="post" action="" autocomplete="off" id="verification-form">
              {% csrf_token %}
              
              <!-- Include form fields from partial template -->
              <!-- Reference: templates/users/_form_fields_register.html -->
              {% include "users/_form_fields_register.html" with disable_fields=disable_fields %}

              <!-- Verification code input (only shown in verify step) -->
              {% if show_token_field %}
                <div class="mb-3">
                  <label for="verification_code" class="form-label">Verification Code</label>
                  <textarea 
                    name="verification_code"
                    id="verification_code"
                    class="form-control form-control-app input-token"
                    placeholder="Enter your 15-character code"
                    required
                    {% if not can_verify %}disabled{% endif %}
                    autocapitalize="none"
                    autocorrect="off"
                    spellcheck="false"
                    maxlength="15"
                    rows="2"></textarea>
                  <small class="text-muted">Check your email for the verification code</small>
                </div>

                <!-- Token countdown timer -->
                <div class="text-center mb-3">
                  <small class="text-muted">
                    {% if not token_expired %}
                      <i class="fas fa-clock"></i>
                      Time remaining: <span id="countdown-timer" class="fw-bold">{{ countdown }}</span>
                    {% else %}
                      <span class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Your code has expired
                      </span>
                    {% endif %}
                  </small>
                </div>
              {% endif %}

              <!-- reCAPTCHA (only for initial registration) -->
              {% if not show_token_field %}
                <div class="d-flex justify-content-center mt-3 mb-2">
                  <div style="transform: scale(0.85); transform-origin: 0 0;">
                    <div class="g-recaptcha" data-sitekey="{{ RECAPTCHA_SITE_KEY }}"></div>
                  </div>
                </div>
              {% endif %}

              <!-- Submit button with dynamic text and state -->
              <button 
                type="submit" 
                class="btn btn-primary-app w-100" 
                id="verify-code-button"
                name="{% if show_token_field %}verify_code{% else %}register{% endif %}"
                {% if show_token_field and not can_verify %}disabled{% endif %}>
                {% if show_token_field %}
                  <span id="verify-button-text">Verify Code</span>
                {% else %}
                  Sign up
                {% endif %}
              </button>
            </form>

            <!-- Resend code form (separate form to handle different action) -->
            {% if show_token_field %}
              <form method="post" action="" class="mt-2">
                {% csrf_token %}
                <button 
                  type="submit"
                  class="btn btn-outline-secondary w-100"
                  id="resend-code-button"
                  name="resend_code"
                  {% if not can_resend %}disabled{% endif %}>
                  <span id="resend-button-text">Re-send Code</span>
                </button>
              </form>
              
              <!-- Show resend attempts remaining -->
              {% if resend_count > 0 %}
                <small class="text-muted d-block text-center mt-1">
                  Resend attempts: {{ resend_count }}/{{ max_resend_count }}
                </small>
              {% endif %}
            {% endif %}

            <!-- Login link -->
            <div class="text-center mt-3">
              <a href="{% url 'users:login' %}" class="text-decoration-none text-info small">
                Already have an account? Log in
              </a>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}

    {# This script only loads on the initial registration screen (Step 1). #}
    {% if not show_token_field %}
        
        <script src="{% static 'js/users_register/password_checklist.js' %}"></script>
    
    {% endif %}


    {# These scripts only load on the token verification screen (Step 2). #}
    {% if show_token_field %}

        <script src="{% static 'js/users_register/token_status_checker.js' %}"></script>
        
        <script>
            /**
             * Initializes the token status checker with context from the Django backend.
             * The data is provided by `_render_verification_step()` in `users/views/register.py`.
             */
            initTokenStatusChecker({
              // The initial time in seconds for the countdown.
              initialCountdown: {{ countdown|default:0 }},
              
              // Boolean flags controlling UI state, converted to lowercase for JS compatibility.
              isExpired: {{ token_expired|yesno:"true,false"|lower }},
              canVerify: {{ can_verify|yesno:"true,false"|lower }},
              canResend: {{ can_resend|yesno:"true,false"|lower }}
            });
        </script>

    {% endif %}

{% endblock %}